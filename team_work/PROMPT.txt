# éªæµ (Flow State) æž¶æž„åä½œåè®®ä¸Žå…³é”®è¯é›†

è¿™ä»½æ–‡æ¡£æ˜¯å›¢é˜Ÿåä½œçš„â€œé€šå¤©å¡”â€è“å›¾ã€‚è¯·æ ¹æ®ä½ çš„è§’è‰²ï¼Œå¤åˆ¶å¯¹åº”çš„ä»£ç å—åˆ°ä½ çš„æ¨¡å—ä¸­ï¼Œä»¥ç¡®ä¿æ•´ä¸ªç³»ç»Ÿèƒ½åƒç²¾å¯†é½¿è½®ä¸€æ ·å’¬åˆè¿è¡Œã€‚

---

## 1. å…¨å±€æ•°æ®åè®® (The Esperanto)ï¼ˆåŽç«¯ï¼‰ï¼ˆå‰ç«¯ï¼‰
**æ‰€æœ‰è§’è‰²å¿…é¡»éµå®ˆçš„æ•°æ®æ ¼å¼**ã€‚æ— è®ºæ˜¯ AI å‘ç»™ UIï¼Œè¿˜æ˜¯åŽç«¯å‘ç»™å‰ç«¯ï¼ŒçŠ¶æ€å¯¹è±¡å¿…é¡»é•¿è¿™æ ·ã€‚

### A. å®žæ—¶çŠ¶æ€å¯¹è±¡ (Real-time Status Object)
> **é€‚ç”¨åœºæ™¯**: è¿›ç¨‹é—´é€šä¿¡ (Queue)ã€Websocket æŽ¨é€ã€å‰ç«¯è½®è¯¢çŠ¶æ€

```python
{
    "status": "focus",          # æžšä¸¾: "focus" | "entertainment" | "idle" | "distracted"
    "duration": 120,            # å½“å‰çŠ¶æ€æŒç»­ç§’æ•° (int)
    "confidence": 0.95,         # AI ç½®ä¿¡åº¦ (float 0.0-1.0)
    "message": "æ·±åº¦ä¸“æ³¨ä¸­...",   # ç»™ç”¨æˆ·çœ‹çš„æç¤ºè¯­ (str)
    "timestamp": 1705046400.0,  # Unix æ—¶é—´æˆ³ (float)
    "metadata": {               # å¯é€‰æ‰©å±•å­—æ®µ
        "app_name": "PyCharm",  # å½“å‰å‰å°åº”ç”¨
        "is_complex_scene": False 
    }
}
```

### B. æ•°æ®åº“è¡¨ç»“æž„ (Database Schema)ï¼ˆåŽç«¯ï¼‰
> **é€‚ç”¨åœºæ™¯**: åŽç«¯å­˜å–ã€æ•°æ®åˆ†æžå¸ˆå†™ SQL

*   **è¡¨å**: `activity_logs`
*   **å­—æ®µ**:
    *   `id` (PK, Auto Inc)
    *   `timestamp` (DateTime) -> è®°å½•æ—¶åˆ»
    *   `status` (Text) -> ä¸Šè¿°æžšä¸¾å€¼
    *   `duration` (Int) -> æŒç»­æ—¶é•¿
*   **è¡¨å**: `ocr_records` (æœªæ¥æ‰©å±•)
    *   `content` (Text) -> è¯†åˆ«åˆ°çš„æ–‡å­—
    *   `app_name` (Text) -> æ¥æºåº”ç”¨

---

## 2. è§’è‰²åˆ†å·¥ä¸Žå…³é”®è¯ (Role-Specific Prompts)

### ðŸ‘®â€â™‚ï¸ è§’è‰² A: AI å·¥ç¨‹å¸ˆ (AI Worker)
**ä½ çš„ä»»åŠ¡**: ç›¯ç€æ‘„åƒå¤´ï¼Œäº§å‡ºçŠ¶æ€ï¼Œä¸¢è¿›é˜Ÿåˆ—ã€‚

> **å¤åˆ¶è¿™æ®µä»£ç åˆ° `app/services/ai_worker.py`**:
```python
# [PROTOCOL] AI Output Format
monitor_data = {
    "status": detected_status,  # "focus" / "entertainment"
    "duration": current_duration,
    "message": status_message,
    "timestamp": time.time()
}
# [ACTION] Push to Queue
# å¿…é¡»ä½¿ç”¨éžé˜»å¡žæ–¹å¼ï¼Œé˜²æ­¢å¡æ­» AI è¿›ç¨‹
if not msg_queue.full():
    msg_queue.put_nowait(monitor_data)
```

### ðŸ–¥ï¸ è§’è‰² B: æ¡Œé¢ UI å·¥ç¨‹å¸ˆ (Main Process)
**ä½ çš„ä»»åŠ¡**: ä»Žé˜Ÿåˆ—æ‹¿æ•°æ®ï¼Œæ›´æ–°æ‚¬æµ®çƒï¼Œä¸å‡†å¡é¡¿ã€‚

> **å¤åˆ¶è¿™æ®µä»£ç åˆ° `app/main.py`**:
```python
# [PROTOCOL] UI Update Loop
def check_queue():
    try:
        while not msg_queue.empty():
            data = msg_queue.get_nowait()
            # [KEYWORD] Update UI Components
            status = data.get('status', 'idle')
            popup.update_focus_status(data)
            ball.update_state(status)
    except queue.Empty:
        pass
# [ACTION] Timer Setup
timer = QtCore.QTimer()
timer.timeout.connect(check_queue)
timer.start(100) # 10Hz Refresh Rate
```

### ðŸŒ è§’è‰² C: Web åŽç«¯å·¥ç¨‹å¸ˆ (Flask Server)
**ä½ çš„ä»»åŠ¡**: åªè¯»æ•°æ®åº“ï¼Œæä¾› APIï¼Œä¸å‡†ç›´æŽ¥ç¢° UI çº¿ç¨‹ã€‚

> **å¤åˆ¶è¿™æ®µä»£ç åˆ° `app/services/web_server.py`**:
```python
# [PROTOCOL] API Response Format
@app.route('/api/status/current')
def get_current_status():
    # [KEYWORD] Read-Only Access
    # Web è¿›ç¨‹ä¸åº”ç›´æŽ¥è¯»å– Queueï¼Œåº”æŸ¥è¯¢æ•°æ®åº“æœ€æ–°ä¸€æ¡è®°å½•æˆ–å…±äº«å†…å­˜
    # è¿™é‡Œæ¼”ç¤ºæ ‡å‡† JSON å“åº”
    return jsonify({
        "code": 200,
        "data": {
            "status": "focus",
            "date": "2026-01-13"
        }
    })
```

### ðŸŽ¨ è§’è‰² D: Web å‰ç«¯å·¥ç¨‹å¸ˆ (Vue/JS)
**ä½ çš„ä»»åŠ¡**: è°ƒç”¨ APIï¼Œç”»æ¼‚äº®çš„å›¾è¡¨ã€‚

> **å¤åˆ¶è¿™æ®µä»£ç åˆ° `app/web/frontend/src/api.js`**:
```javascript
// [PROTOCOL] Frontend Fetcher
async function fetchHistory(dateStr) {
    // [KEYWORD] Endpoint
    const response = await fetch(`http://localhost:5000/api/history?date=${dateStr}`);
    const json = await response.json();
    // Expected JSON: { "focus_time": 120, "distract_time": 30, ... }
    return json;
}
```

---
è§’è‰² E: æž¶æž„å¸ˆ 

## 3. è¿›ç¨‹é—´é€šä¿¡å…³é”®è¯ (IPC Keywords)

*   **`msg_queue`**: å”¯ä¸€çš„å•å‘é€šé“ã€‚**AI è¿›ç¨‹åªç®¡å†™ (Put)ï¼ŒUI è¿›ç¨‹åªç®¡è¯» (Get)**ã€‚
*   **`running_event`**: å…¨å±€çš„â€œè‡ªæ¯æŒ‰é’®â€ã€‚ä»»ä½•è¿›ç¨‹çœ‹åˆ° `running_event.is_set() == False` æ—¶ï¼Œå¿…é¡»ç«‹å³æ¸…ç†èµ„æºå¹¶é€€å‡ºã€‚
*   **`sqlite_lock`**: è™½ç„¶ SQLite æ”¯æŒå¹¶å‘è¯»ï¼Œä½†**å†™æ“ä½œ**æœ€å¥½ç”± AI è¿›ç¨‹ç‹¬å ã€‚å¦‚æžœ Web ç«¯å°†æ¥è¦å†™æ•°æ®ï¼ˆå¦‚ç”¨æˆ·å¤‡æ³¨ï¼‰ï¼Œå¿…é¡»åšå¥½æ•°æ®åº“é”å¤„ç†ã€‚

## 4. è°ƒè¯•æš—å· (Debug Signals)

*   å½“æŽ§åˆ¶å°æ‰“å° `ã€AIç›‘æŽ§è¿›ç¨‹ã€‘...` -> è¯´æ˜Žæ‘„åƒå¤´å’Œç®—æ³•æ´»ç€ã€‚
*   å½“æŽ§åˆ¶å°æ‰“å° `ã€WebæœåŠ¡è¿›ç¨‹ã€‘...` -> è¯´æ˜Žç½‘é¡µèƒ½æ‰“å¼€ã€‚
*   å½“æ‚¬æµ®çƒå˜è‰² -> è¯´æ˜Ž `msg_queue` é€šè·¯ç•…é€šã€‚
*   å¦‚æžœæ‚¬æµ®çƒä¸åŠ¨ä½†æŽ§åˆ¶å°åœ¨åˆ·å± -> è¯´æ˜Ž UI çº¿ç¨‹çš„ `QTimer` æŒ‚äº†æˆ–è€…é˜Ÿåˆ—å µå¡žã€‚
